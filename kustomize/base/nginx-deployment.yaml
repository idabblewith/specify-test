apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: specify
    component: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: specify
      component: nginx
  template:
    metadata:
      labels:
        app: specify
        component: nginx
    spec:
      initContainers:
      # Copy static files from Specify image to Nginx volume
      - name: copy-static-files
        image: specifyconsortium/specify7-service:v7.11.2
        command: 
        - sh
        - -c
        - |
          echo "Copying static files from Specify image..."
          mkdir -p /static-files
          cp -rv /opt/specify7/specifyweb/frontend/static/* /static-files/
          echo "Static files copied successfully"
          ls -la /static-files/
        volumeMounts:
        - name: static-files
          mountPath: /static-files
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: nginx.conf
          readOnly: true
        - name: static-files
          mountPath: /static-files
          readOnly: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: static-files
        emptyDir: {}  # No shared storage needed!
