apiVersion: v1
data:
  default.conf: "upstream specify_app {\n    server specify-app-service:8000;\n}\n\nserver
    {\n    listen 80;\n    server_name _;\n    \n    # Health check endpoint\n    location
    /health {\n        access_log off;\n        return 200 \"healthy\\n\";\n        add_header
    Content-Type text/plain;\n    }\n    \n    # Serve static files\n    location
    /static/ {\n        alias /usr/share/nginx/html/static/;\n        expires 1y;\n
    \       add_header Cache-Control \"public, immutable\";\n    }\n    \n    # Serve
    Specify6 files\n    location /specify6/ {\n        alias /usr/share/nginx/html/specify6/;\n
    \       expires 1y;\n        add_header Cache-Control \"public, immutable\";\n
    \   }\n    \n    # Proxy to Specify application\n    location / {\n        proxy_pass
    http://specify_app;\n        proxy_set_header Host $host;\n        proxy_set_header
    X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n
    \       proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}"
kind: ConfigMap
metadata:
  labels:
    variant: test
  name: nginx-config-test
---
apiVersion: v1
data: {}
kind: Secret
metadata:
  labels:
    variant: test
  name: specify-secrets-test
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    variant: test
  name: asset-server-service-test
spec:
  ports:
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: asset-server-deployment
    variant: test
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    variant: test
  name: nginx-service-test
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: nginx-deployment
    variant: test
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    variant: test
  name: redis-service-test
spec:
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379
  selector:
    app: redis-deployment
    variant: test
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    variant: test
  name: report-runner-service-test
spec:
  ports:
  - name: http
    port: 8088
    protocol: TCP
    targetPort: 8088
  selector:
    app: report-runner-deployment
    variant: test
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    variant: test
  name: specify-app-service-test
spec:
  ports:
  - name: http
    port: 8000
    protocol: TCP
    targetPort: 8000
  selector:
    app: specify-app-deployment
    variant: test
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    component: storage
    variant: test
  name: attachments-pvc-test
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    component: storage
    variant: test
  name: redis-data-pvc-test
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    component: storage
    variant: test
  name: specify6-pvc-test
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    component: storage
    variant: test
  name: static-files-pvc-test
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 2Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: asset-server-deployment
    variant: test
  name: asset-server-deployment-test
spec:
  selector:
    matchLabels:
      app: asset-server-deployment
      variant: test
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: asset-server-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - image: specifyconsortium/specify-asset-service:latest
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        name: asset-server
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 2
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 100m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /home/specify/attachments
          name: attachments-volume
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
      - name: attachments-volume
        persistentVolumeClaim:
          claimName: attachments-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: tmp-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-deployment
    variant: test
  name: nginx-deployment-test
spec:
  selector:
    matchLabels:
      app: nginx-deployment
      variant: test
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: nginx-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - image: nginx:1-trixie
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        name: nginx
        ports:
        - containerPort: 80
        readinessProbe:
          failureThreshold: 2
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /etc/nginx/conf.d
          name: nginx-config
        - mountPath: /usr/share/nginx/html/static
          name: static-files-volume
        - mountPath: /usr/share/nginx/html/specify6
          name: specify6-volume
        - mountPath: /tmp
          name: tmp-volume
        - mountPath: /var/cache/nginx
          name: var-cache-nginx
        - mountPath: /var/run
          name: var-run
      restartPolicy: Always
      securityContext:
        fsGroup: 101
        runAsGroup: 101
        runAsNonRoot: true
        runAsUser: 101
      volumes:
      - configMap:
          name: nginx-config-test
        name: nginx-config
      - name: static-files-volume
        persistentVolumeClaim:
          claimName: static-files-pvc-test
      - name: specify6-volume
        persistentVolumeClaim:
          claimName: specify6-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: tmp-volume
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: var-cache-nginx
      - emptyDir:
          medium: Memory
          sizeLimit: 10Mi
        name: var-run
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis-deployment
    variant: test
  name: redis-deployment-test
spec:
  selector:
    matchLabels:
      app: redis-deployment
      variant: test
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: redis-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - image: redis:6.0
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          initialDelaySeconds: 30
          periodSeconds: 10
          tcpSocket:
            port: 6379
          timeoutSeconds: 5
        name: redis
        ports:
        - containerPort: 6379
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          failureThreshold: 2
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /data
          name: redis-data-volume
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 999
        runAsGroup: 999
        runAsNonRoot: true
        runAsUser: 999
      volumes:
      - name: redis-data-volume
        persistentVolumeClaim:
          claimName: redis-data-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: tmp-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: report-runner-deployment
    variant: test
  name: report-runner-deployment-test
spec:
  selector:
    matchLabels:
      app: report-runner-deployment
      variant: test
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: report-runner-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - image: specifyconsortium/report-runner:latest
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        name: report-runner
        ports:
        - containerPort: 8088
        readinessProbe:
          failureThreshold: 2
          httpGet:
            path: /ready
            port: 8088
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 100m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: tmp-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: specify-app-deployment
    variant: test
  name: specify-app-deployment-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: specify-app-deployment
      variant: test
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: specify-app-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - env:
        - name: TZ
          value: Australia/Perth
        - name: DATABASE_HOST
          valueFrom:
            secretKeyRef:
              key: DATABASE_HOST
              name: specify-secrets-test
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: DATABASE_NAME
              name: specify-secrets-test
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: DATABASE_USER
              name: specify-secrets-test
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: DATABASE_PASSWORD
              name: specify-secrets-test
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: SECRET_KEY
              name: specify-secrets-test
        - name: DEBUG
          valueFrom:
            secretKeyRef:
              key: DEBUG
              name: specify-secrets-test
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              key: REDIS_URL
              name: specify-secrets-test
        - name: ASSET_SERVER_URL
          valueFrom:
            secretKeyRef:
              key: ASSET_SERVER_URL
              name: specify-secrets-test
        - name: ASSET_SERVER_KEY
          valueFrom:
            secretKeyRef:
              key: ASSET_SERVER_KEY
              name: specify-secrets-test
        image: specifyconsortium/specify7-service:v7.11.2
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /accounts/login/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
        name: specify-app
        ports:
        - containerPort: 8000
        readinessProbe:
          failureThreshold: 2
          httpGet:
            path: /api/specify/user/
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 250m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /opt/Specify6
          name: specify6-volume
        - mountPath: /opt/Specify7/specifyweb/frontend/static
          name: static-files-volume
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
      - name: specify6-volume
        persistentVolumeClaim:
          claimName: specify6-pvc-test
      - name: static-files-volume
        persistentVolumeClaim:
          claimName: static-files-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 100Mi
        name: tmp-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: specify-worker-deployment
    variant: test
  name: specify-worker-deployment-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: specify-worker-deployment
      variant: test
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: specify-worker-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - command:
        - ve/bin/celery
        - -A
        - specifyweb
        - worker
        - -l
        - INFO
        - --concurrency=1
        env:
        - name: TZ
          value: Australia/Perth
        - name: DATABASE_HOST
          valueFrom:
            secretKeyRef:
              key: DATABASE_HOST
              name: specify-secrets-test
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: DATABASE_NAME
              name: specify-secrets-test
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: DATABASE_USER
              name: specify-secrets-test
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: DATABASE_PASSWORD
              name: specify-secrets-test
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: SECRET_KEY
              name: specify-secrets-test
        - name: DEBUG
          valueFrom:
            secretKeyRef:
              key: DEBUG
              name: specify-secrets-test
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              key: REDIS_URL
              name: specify-secrets-test
        - name: ASSET_SERVER_URL
          valueFrom:
            secretKeyRef:
              key: ASSET_SERVER_URL
              name: specify-secrets-test
        - name: ASSET_SERVER_KEY
          valueFrom:
            secretKeyRef:
              key: ASSET_SERVER_KEY
              name: specify-secrets-test
        image: specifyconsortium/specify7-service:v7.11.2
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - ve/bin/celery -A specifyweb inspect ping -d celery@$HOSTNAME
          failureThreshold: 3
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        name: specify-worker
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - ve/bin/celery -A specifyweb inspect ping -d celery@$HOSTNAME
          failureThreshold: 2
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 100m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /opt/Specify6
          name: specify6-volume
        - mountPath: /opt/Specify7/specifyweb/frontend/static
          name: static-files-volume
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
      - name: specify6-volume
        persistentVolumeClaim:
          claimName: specify6-pvc-test
      - name: static-files-volume
        persistentVolumeClaim:
          claimName: static-files-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 100Mi
        name: tmp-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: specify6-deployment
    variant: test
  name: specify6-deployment-test
spec:
  selector:
    matchLabels:
      app: specify6-deployment
      variant: test
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: specify6-deployment
        variant: test
    spec:
      automountServiceAccountToken: false
      containers:
      - image: specifyconsortium/specify6-service:6.8.03
        imagePullPolicy: Always
        name: specify6
        resources:
          limits:
            cpu: 50m
            memory: 128Mi
          requests:
            cpu: 25m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        volumeMounts:
        - mountPath: /volumes/Specify6
          name: specify6-volume
        - mountPath: /tmp
          name: tmp-volume
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
      - name: specify6-volume
        persistentVolumeClaim:
          claimName: specify6-pvc-test
      - emptyDir:
          medium: Memory
          sizeLimit: 50Mi
        name: tmp-volume
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  labels:
    variant: test
  name: nginx-deployment-hpa-test
spec:
  maxReplicas: 2
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 60
        type: Utilization
    type: Resource
  - resource:
      name: memory
      target:
        averageUtilization: 70
        type: Utilization
    type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-deployment-test
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  labels:
    variant: test
  name: specify-app-deployment-hpa-test
spec:
  maxReplicas: 2
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 70
        type: Utilization
    type: Resource
  - resource:
      name: memory
      target:
        averageUtilization: 80
        type: Utilization
    type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: specify-app-deployment-test
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  labels:
    variant: test
  name: specify-worker-deployment-hpa-test
spec:
  maxReplicas: 2
  metrics:
  - resource:
      name: cpu
      target:
        averageUtilization: 75
        type: Utilization
    type: Resource
  - resource:
      name: memory
      target:
        averageUtilization: 85
        type: Utilization
    type: Resource
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: specify-worker-deployment-test
