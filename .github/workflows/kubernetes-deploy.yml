name: Kubernetes Deployment

on:
  push:
    branches: [main, develop]
    paths: ['kustomize/**']
  pull_request:
    branches: [main]
    paths: ['kustomize/**']

env:
  KUBECTL_VERSION: "1.29.0"

jobs:
  validate:
    name: Validate Kustomize Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: Validate development overlay
        run: |
          echo "Validating development overlay..."
          kubectl kustomize kustomize/overlays/development > /tmp/dev-output.yaml
          echo "âœ… Development overlay validation successful"
          
      - name: Validate UAT overlay
        run: |
          echo "Validating UAT overlay..."
          kubectl kustomize kustomize/overlays/uat > /tmp/uat-output.yaml
          echo "âœ… UAT overlay validation successful"
          
      - name: Validate production overlay
        run: |
          echo "Validating production overlay..."
          kubectl kustomize kustomize/overlays/production > /tmp/prod-output.yaml
          echo "âœ… Production overlay validation successful"
          
      - name: Check for required resources
        run: |
          echo "Checking for required Kubernetes resources..."
          
          # Check development overlay
          if ! grep -q "kind: Deployment" /tmp/dev-output.yaml; then
            echo "âŒ No Deployments found in development overlay"
            exit 1
          fi
          
          if ! grep -q "kind: Service" /tmp/dev-output.yaml; then
            echo "âŒ No Services found in development overlay"
            exit 1
          fi
          
          if ! grep -q "kind: Namespace" /tmp/dev-output.yaml; then
            echo "âŒ No Namespace found in development overlay"
            exit 1
          fi
          
          echo "âœ… All required resources found in overlays"
          
      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kustomize-validation-output
          path: /tmp/*-output.yaml
          retention-days: 7

  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: uat
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: Configure kubectl for UAT cluster
        run: |
          echo "Configuring kubectl for UAT cluster context..."
          # Note: In real implementation, this would use Azure CLI or kubeconfig
          # kubectl config use-context az-aks-oim03
          echo "UAT cluster context configured"
          
      - name: Pre-deployment validation
        run: |
          echo "Running comprehensive pre-deployment validation..."
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh uat
          echo "âœ… Pre-deployment validation successful"
          
      - name: Deploy to UAT
        run: |
          echo "Deploying to UAT environment..."
          # kubectl apply -k kustomize/overlays/uat --dry-run=server
          # kubectl apply -k kustomize/overlays/uat
          echo "âœ… UAT deployment completed"
          
      - name: Wait for deployment rollout
        run: |
          echo "Waiting for deployment rollout..."
          # kubectl rollout status deployment/specify-app-deployment -n herbarium-specify --timeout=300s
          # kubectl rollout status deployment/nginx-deployment -n herbarium-specify --timeout=300s
          echo "âœ… Deployment rollout completed"
          
      - name: Post-deployment health checks
        run: |
          echo "Running comprehensive post-deployment health checks..."
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh --wait --timeout=300 --connectivity --report
          echo "âœ… Health checks passed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-uat]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: Configure kubectl for Production cluster
        run: |
          echo "Configuring kubectl for Production cluster context..."
          # Note: In real implementation, this would use Azure CLI or kubeconfig
          # kubectl config use-context az-aks-prod01
          echo "Production cluster context configured"
          
      - name: Pre-deployment validation
        run: |
          echo "Running comprehensive pre-deployment validation..."
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh production
          echo "âœ… Pre-deployment validation successful"
          
      - name: Create deployment backup
        run: |
          echo "Creating deployment backup..."
          chmod +x scripts/rollback-deployment.sh
          mkdir -p backups
          kubectl get all,pvc,configmap,secret,ingress -n herbarium-specify -o yaml > "backups/pre-deploy-$(date +%Y%m%d-%H%M%S).yaml" 2>/dev/null || true
          echo "âœ… Deployment backup created"
          
      - name: Deploy to Production
        id: deploy
        run: |
          echo "Deploying to Production environment..."
          # kubectl apply -k kustomize/overlays/production --dry-run=server
          # kubectl apply -k kustomize/overlays/production
          echo "âœ… Production deployment completed"
          
      - name: Wait for deployment rollout
        run: |
          echo "Waiting for deployment rollout..."
          # kubectl rollout status deployment/specify-app-deployment -n herbarium-specify --timeout=600s
          # kubectl rollout status deployment/nginx-deployment -n herbarium-specify --timeout=600s
          echo "âœ… Deployment rollout completed"
          
      - name: Post-deployment health checks
        id: health-check
        run: |
          echo "Running comprehensive post-deployment health checks..."
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh --wait --timeout=600 --connectivity --report
          echo "âœ… Health checks passed"
          
      - name: Rollback on failure
        if: failure() && (steps.deploy.outcome == 'failure' || steps.health-check.outcome == 'failure')
        run: |
          echo "âŒ Deployment failed, initiating automated rollback..."
          chmod +x scripts/rollback-deployment.sh
          ./scripts/rollback-deployment.sh emergency
          echo "ðŸ”„ Emergency rollback completed"
          exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: Scan for security issues
        run: |
          echo "Scanning Kustomize configuration for security issues..."
          
          # Generate all overlays for scanning
          kubectl kustomize kustomize/overlays/development > /tmp/dev-scan.yaml
          kubectl kustomize kustomize/overlays/uat > /tmp/uat-scan.yaml
          kubectl kustomize kustomize/overlays/production > /tmp/prod-scan.yaml
          
          # Check for security best practices
          echo "Checking for security best practices..."
          
          # Check for resource limits
          if ! grep -q "resources:" /tmp/prod-scan.yaml; then
            echo "âš ï¸  Warning: No resource limits found in production"
          fi
          
          # Check for security contexts
          if ! grep -q "securityContext:" /tmp/prod-scan.yaml; then
            echo "âš ï¸  Warning: No security contexts found"
          fi
          
          # Check for secrets in plaintext (should not exist)
          if grep -i "password\|secret\|key" /tmp/prod-scan.yaml | grep -v "secretKeyRef\|secretName"; then
            echo "âŒ Potential plaintext secrets found"
            exit 1
          fi
          
          echo "âœ… Security scan completed"

  comprehensive-validation:
    name: Comprehensive Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}
          
      - name: Run comprehensive validation
        run: |
          echo "Running comprehensive validation for all overlays..."
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh all
          
      - name: Validate deployment scripts
        run: |
          echo "Validating deployment scripts..."
          chmod +x scripts/health-check.sh scripts/rollback-deployment.sh
          
          # Test script help functions
          ./scripts/health-check.sh --help > /dev/null
          ./scripts/rollback-deployment.sh --help > /dev/null
          
          echo "âœ… All deployment scripts validated"
          
      - name: Generate validation report
        run: |
          echo "Generating validation report..."
          
          echo "## Kustomize Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "### Generated Resources Summary" >> validation-report.md
          echo "" >> validation-report.md
          
          for overlay in development uat production; do
            echo "#### $overlay overlay" >> validation-report.md
            echo '```yaml' >> validation-report.md
            kubectl kustomize "kustomize/overlays/$overlay" | grep -E "^(kind|metadata)" | head -20 >> validation-report.md
            echo '```' >> validation-report.md
            echo "" >> validation-report.md
          done
          
          echo "âœ… Validation report generated"
          
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 30